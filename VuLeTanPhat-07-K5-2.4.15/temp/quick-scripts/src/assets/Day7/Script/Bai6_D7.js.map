{"version":3,"sources":["assets/Day7/Script/Bai6_D7.js"],"names":["cc","Class","Component","properties","TimeOut","Tile","Label","Body","spriteArray","type","Sprite","fetchImageWithTimeout","url","timeout","Promise","resolve","reject","controller","AbortController","signal","timeoutId","setTimeout","abort","fetch","then","response","clearTimeout","ok","Error","status","blob","img","Image","src","URL","createObjectURL","onload","onerror","err","error","name","call","urls","promises","map","all","results","i","length","result","string","texture","Texture2D","initWithElement","handleLoadedTexture","spriteFrame","SpriteFrame","console","warn","message","start"],"mappings":"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","sourceRoot":"/","sourcesContent":["cc.Class({\n    extends: cc.Component,\n\n    properties: {\n        TimeOut: 10000,\n        Tile: cc.Label,\n        Body: cc.Label,\n\n        spriteArray: {\n            default: [],\n            type: [cc.Sprite]\n        }\n    },\n\n    fetchImageWithTimeout(url, timeout) { //fetch anh url va thoi gian het han\n        return new Promise((resolve, reject) => { // 2 trang thai resolve va reject\n            const controller = new AbortController(); // tao 1 controller huy fetch\n            const signal = controller.signal; // dung de lien ket vs fetch\n\n            const timeoutId = setTimeout(() => {\n                controller.abort();\n            }, timeout); // set time out de het time out roi goi abort\n\n            fetch(url, { signal }) // url va doi so signal\n                .then(response => { // tra ve rq\n                    clearTimeout(timeoutId);// huy time out neu dc tra ve\n                    if (!response.ok) {\n                        throw new Error(`HTTP error! Status: ${response.status}`);\n                    }\n                    return response.blob();\n                })\n                .then(blob => { // lay du lieu\n                    let img = new Image();\n                    img.src = URL.createObjectURL(blob);\n                    img.onload = () => resolve(img);\n                    img.onerror = err => reject(err);\n                })\n                .catch(error => { // neu k du thoi gian\n                    if (error.name === 'AbortError') {\n                        reject(new Error('Request timed out'));\n                    } else {\n                        reject(error);\n                    }\n                });\n        });\n    },\n\n    async call() { //tai nhieu anh song song\n        const urls = [\n            'https://picsum.photos/id/237/300/200',\n            'https://fastly.picsum.photos/id/3/5000/3333.jpg?hmac=GDjZ2uNWE3V59PkdDaOzTOuV3tPWWxJSf4fNcxu4S2g',\n            'https://fastly.picsum.photos/id/1/5000/3333.jpg?hmac=Asv2DU3rA_5D1xSe22xZK47WEAN0wjWeFOhzd13ujW4',\n            'https://fastly.picsum.photos/id/2/5000/3333.jpg?hmac=_KDkqQVttXw_nM-RyJfLImIbafFrqLsuGO5YuHqD-qQ',\n            'https://fastly.picsum.photos/id/3/5000/3333.jpg?hmac=GDjZ2uNWE3V59PkdDaOzTOuV3tPWWxJSf4fNcxu4S2g'\n        ];\n\n        const promises = urls.map(url => // duyet qua URL, tao promise\n            this.fetchImageWithTimeout(url, this.TimeOut)\n                .then(img => ({ status: 'fulfilled', img, url }))\n                .catch(error => ({ status: 'rejected', error, url }))\n        );\n\n        const results = await Promise.all(promises); // doi anh tai thanh cong or that bai\n\n        for (let i = 0; i < results.length; i++) {\n            const result = results[i];\n\n            if (result.status === 'fulfilled') {\n                this.Tile.string = \"Image loaded:\";\n                this.Body.string = result.url;// day la anh dc tai thanh cong\n\n                let texture = new cc.Texture2D();\n                texture.initWithElement(result.img);\n                texture.handleLoadedTexture(); // cap nhat UI\n\n                let spriteFrame = new cc.SpriteFrame(texture);// tao spriteframe\n\n                if (i < this.spriteArray.length) { // gan anh vao sprite tuong ung\n                    this.spriteArray[i].spriteFrame = spriteFrame;\n                } else {\n                    console.warn(`No sprite available for index ${i}`);\n                }\n\n            } else { // neu loi hien thi loi trong UI + log loi~\n                this.Tile.string = \"Error:\";\n                this.Body.string = result.error.message;\n                console.error(\"Error loading image:\", result.url, result.error);\n            }\n        }\n    },\n\n    start() {\n        this.call();\n    },\n});\n\n\n\n//Câu hỏi:\n// abort.controller co xai dc cho khac, VD: axios\n// duoc su dung o cho nao, platform nao ho tro\n\n\n//Trả lời\n// Abort controller có dùng được ngoài fetch không ?\n// Có, nhưng không được sử dụng với các phương thức khác như axios, request, ...\n// Vì AbortController bản chất chỉ là công cụ phát tín hiệu cancel thông qua signal, chứ \n// không tự huỷ được\n// Vì thế API nào được thế kế để \"nghe\" tín hiệu này mới phản hồi\n\n// Fetch thì đương nhiên là xài được và dùng phổ biến nhất\n// ReadableStream, WritableStream xài được trong API stream\n// XMLHttpRequest xài được\n// navigator.sendBeacon(trình duyệt): không xài được\n// setTimeout, setInterval không xài được, thay vào đó ta phải viết wrapper\n// Axios thì tuỳ phiên bản, hiện tại sử dụng CancelToken ở v0.21 trở xuống\n// một số bên thư viện thứ 3 : got, ky, node-fetch có hỗ trợ rõ ràng\n// Web API như AudiContext, WebRTC, thì cũng tuỳ do không đồng nhất browser\n\n// AbortController không chỉ dùng cho fetch, nhưng phụ thuộc vào việc thư viện/API có hỗ trợ signal hay không.\n\n// fetch là ví dụ điển hình nhất vì nó hỗ trợ AbortSignal gốc từ trình duyệt.\n\n// Một số thư viện phổ biến (Axios, jQuery Ajax...) phải dùng cơ chế riêng."]}